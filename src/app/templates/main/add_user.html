{% extends "users_base.html" %}

{% block app_content %}

<div class="card">
  <div class="card-header">
      <h5>Add user</h5>
  </div>
  <div class="card-body">
    <form id="add_list_user" class="form-horizontal mb-5" role="form" method="post" action="">
      {{form.hidden_tag()}}
      <div class="input-group form-group">
        <div class="input-group-prepend">
          <div class="input-group-text">
            Groups
          </div>
        </div>
        {{form.group(id="group", class_="form-control")}}
      </div>
      <div class="input-group form-group">
      {{form.users(class_="form-control", rows="10", title="Enter user IDs in multiple lines, all IDs in the same line needs to be comma seperated!", 
            data_placement="top", data_toggle="tooltip",
            placeholder="user IDs (comma seperated in the same line or IDs in multiple lines)")}}
      </div>
      {{form.submit(class_="btn btn-info") }}
    </form>
    
    <div class="input-group form-group">
      <h5>Upload a file with User IDs</h5>
    </div>

    <div class="input-group form-group mt-3">
      <div class="input-group-prepend">
        <div class="input-group-text">
          New file
        </div>
      </div>
      <div class="custom-file">
        <input type="file" class="custom-file-input" name="file_input" id="file_input" oninput="input_filename();"
          accept=".dat, .txt, .list">
        <label id="file_input_label" class="custom-file-label" for="image">Choose file with user IDs...</label>
        </div>
        <button onclick="upload('{{url_for('main.upload_whitelistuser',groupid='')}}');" id="upload_btn" class="btn btn-info">Upload</button>
        <button class="btn btn-primary d-none" id="loading_btn" type="button" disabled>
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Uploading...
        </button>
        <button type="button" id="cancel_btn" class="btn btn-secondary d-none">Cancel upload</button>
      </div>
    </div>
    <div id="progress_wrapper" class="d-none">
      <label id="progress_status"></label>
      <div class="progress mb-3">
        <div id="progress" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
    <div id="alert_wrapper"></div>
    </div>
</div>


{% endblock %}

{% block scripts %}
{{super()}}

<script>
function doStuff(){
  return (confirm('Do you really want to remove these items?'))
}
</script>

<!-- Functionality of upload process -->
<script>

// Add the following code if you want the name of the file appear on select
$(".custom-file-input").on("change", function () {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
});


// javascript code for upload files
// Get a reference to the progress bar, wrapper & status label
var progress = document.getElementById("progress");
var progress_wrapper = document.getElementById("progress_wrapper");
var progress_status = document.getElementById("progress_status");


// Get a reference to the 3 buttons
var upload_btn = document.getElementById("upload_btn");
var loading_btn = document.getElementById("loading_btn");
var cancel_btn = document.getElementById("cancel_btn");

// Get a reference to the alert wrapper
var alert_wrapper = document.getElementById("alert_wrapper");

// Get a reference to the file input element & input label
var input = document.getElementById("file_input");
var file_input_label = document.getElementById("file_input_label");

// Get a reference to the group selector
var group_selector = document.getElementById("group");

// Function to show alerts
function show_alert(message, alert) {

    alert_wrapper.innerHTML = `
    <div id="alert" class="alert alert-${alert} alert-dismissible fade show" role="alert">
      <span>${message}</span>
      <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  `
}


// Function to upload file
function upload(url) {

  // Reject if the file input is empty & throw alert
  if (!input.value) {

    show_alert("No file selected", "warning")

    return;

  }

  // get the group id from the selector widet 
  var group_id = group_selector.value;
  // the url has a / at the end, because of url_for() in
  // python and a reference with a group_id at the end 
  // which is unknown during jinja2 processing and html
  // setup
  var group_url = url + group_id;

  // Create a new FormData instance
  var data = new FormData();
  
  // Create a XMLHTTPRequest instance
  var request = new XMLHttpRequest();
  
  // Set the response type
  request.responseType = "json";
  
  // Clear any existing alerts
  alert_wrapper.innerHTML = "";
  
  // Disable the input during upload
  input.disabled = true;
  
  // Hide the upload button
  upload_btn.classList.add("d-none");

  // Show the loading button
  loading_btn.classList.remove("d-none");
  
  // Show the cancel button
  cancel_btn.classList.remove("d-none");
  
  // Show the progress bar
  progress_wrapper.classList.remove("d-none");
  
  progress.setAttribute("style", `width: 0%`);
  progress.setAttribute("aria-valuenow",`0`);
  
  // Get a reference to the file
  var file = input.files[0];
  
  // Get a reference to the filename
  var filename = file.name;
  
  // Get a reference to the filesize & set a cookie
  var filesize = file.size;
  document.cookie = `filesize=${filesize}`;

  // Append the file to the FormData instance
  data.append("file", file);
  
  // request progress handler
  request.upload.addEventListener("progress", function (e) {
  
    // Get the loaded amount and total filesize (bytes)
    var loaded = e.loaded;
    var total = e.total
  
    // Calculate percent uploaded
    var percent_complete = (loaded / total) * 100;
  
    // Update the progress text and progress bar
    progress.setAttribute("style", `width: ${Math.floor(percent_complete)}%`);
    progress.setAttribute("aria-valuenow", `${Math.floor(percent_complete)}`);
    progress_status.innerText = `${Math.floor(percent_complete)}% uploaded`;
  
  })

  // request load handler (transfer complete)
  request.addEventListener("load", function (e) {
  
    if (request.status == 200) {
  
      show_alert(`${request.response.message}`, "success");
  
  
      // timeout without function wrapper is not workin in Chrome!
      setTimeout(function(){
      //banner_change(this);
        location.reload();
      }, 3000);
    }
    else {
  
      show_alert(`Error uploading file`, "danger");
  
    }
  
    reset();
  
  });

  // request error handler
  request.addEventListener("error", function (e) {
  
    reset();
  
    show_alert(`Error uploading file`, "warning");
  
  });
  
  // request abort handler
  request.addEventListener("abort", function (e) {
  
    reset();
  
    show_alert(`Upload cancelled`, "primary");
  
  });

  // Open and send the request
  request.open("post", group_url);
  request.send(data);
  
  cancel_btn.addEventListener("click", function () {
  
    request.abort();
  
  })
  
}

// Function to update the input placeholder
function input_filename() {

  file_input_label.innerText = input.files[0].name;

}


// Function to reset the page
function reset() {

  // Clear the input
  input.value = null;

  // Hide the cancel button
  cancel_btn.classList.add("d-none");

  // Reset the input element
  input.disabled = false;

  // Show the upload button
  upload_btn.classList.remove("d-none");

  // Hide the loading button
  loading_btn.classList.add("d-none");

  // Hide the progress bar
  progress_wrapper.classList.add("d-none");

  // Reset the progress bar state
  //progress.setAttribute("style", `width: 0%`);
  //progress.setAttribute("aria-valuenow",`0`);

  // Reset the input placeholder
  file_input_label.innerText = "Select file";

}

</script>



{% endblock %}
